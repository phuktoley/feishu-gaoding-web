# V4.2 开发指南：人设关联功能

## 版本信息

| 项目 | 说明 |
|------|------|
| 版本号 | V4.2 |
| 更新日期 | 2026-01-06 |
| 主要功能 | 人设与飞书表格的长期关联 |
| 依赖应用 | 0103XHS (小红书应用) |

## 功能概述

V4.2版本为稿定设计应用（feishu-gaoding-web）新增了**人设关联功能**，允许用户从小红书应用（0103XHS）拉取已配置飞书的人设数据，并建立长期关联。这样用户无需每次手动配置飞书凭证，只需选择人设即可自动获取对应的飞书表格配置。

## 技术架构

### 跨应用通信

由于两个应用使用不同的数据库（0103XHS使用PostgreSQL，feishu-gaoding-web使用MySQL），V4.2采用**API调用方式**实现跨应用数据同步。

```
┌─────────────────────────┐     HTTP API      ┌─────────────────────────┐
│  feishu-gaoding-web     │ ◄───────────────► │      0103XHS            │
│  (稿定设计应用)          │                   │   (小红书应用)           │
├─────────────────────────┤                   ├─────────────────────────┤
│ • PersonaSelector组件   │                   │ • persona.listByUserId  │
│ • 人设关联存储(localStorage)│               │ • persona.getFeishuConfig│
│ • 飞书配置自动填充       │                   │ • personas表(带feishuConfig)│
└─────────────────────────┘                   └─────────────────────────┘
```

### 新增API端点（0103XHS）

在0103XHS的`server/routers.ts`中新增了两个公开API：

1. **persona.listByUserId**: 通过用户ID获取人设列表（仅返回配置了飞书的人设）
2. **persona.getFeishuConfig**: 获取指定人设的完整飞书配置

### 新增组件（feishu-gaoding-web）

1. **PersonaSelector.tsx**: 人设选择器组件，负责：
   - 从0103XHS拉取人设列表
   - 显示人设详情和飞书配置预览
   - 建立/解除人设与飞书配置的长期关联
   - 将关联配置存储到localStorage

2. **Settings.tsx更新**: 添加Tabs切换，支持"人设关联"和"手动配置"两种模式

## 环境变量配置

在Railway中为feishu-gaoding-web添加以下环境变量：

```bash
VITE_XHS_API_URL=https://0103xhs-production.up.railway.app
```

## 数据流程

### 建立关联流程

1. 用户点击"拉取人设列表"
2. 前端调用 `0103XHS/api/trpc/persona.listByUserId`
3. 返回配置了飞书的人设列表（敏感信息已隐藏）
4. 用户选择人设并点击"建立长期关联"
5. 前端调用 `0103XHS/api/trpc/persona.getFeishuConfig` 获取完整配置
6. 将关联信息存储到localStorage
7. 自动调用feishu-gaoding-web的保存配置API

### 使用关联配置流程

1. 用户访问Settings页面
2. 从localStorage读取已关联的人设配置
3. 显示关联状态和配置详情
4. 用户可随时解除关联

## 端到端测试方案

### 测试前提条件

1. 0103XHS应用已部署并可访问
2. 0103XHS中已创建至少一个配置了飞书的人设
3. feishu-gaoding-web已部署并配置了VITE_XHS_API_URL

### 测试用例

| 测试ID | 测试场景 | 预期结果 |
|--------|----------|----------|
| T1 | 拉取人设列表 | 成功获取配置了飞书的人设列表 |
| T2 | 选择人设 | 显示人设详情和飞书配置预览 |
| T3 | 建立关联 | 配置自动保存，显示关联成功状态 |
| T4 | 测试连接 | 使用关联的配置成功连接飞书表格 |
| T5 | 解除关联 | 清空配置，恢复到未关联状态 |
| T6 | 持久化验证 | 刷新页面后关联配置仍然存在 |

### 测试步骤

**T1: 拉取人设列表**
1. 登录feishu-gaoding-web
2. 进入Settings页面
3. 确保在"人设关联"标签页
4. 点击"拉取人设列表"按钮
5. 验证：显示人设列表，数量与0103XHS中配置了飞书的人设一致

**T2: 选择人设**
1. 在人设下拉框中选择一个人设
2. 验证：显示人设详情（名称、类型、描述、App Token、Table ID）

**T3: 建立关联**
1. 选择人设后点击"建立长期关联"
2. 验证：
   - 显示"已关联人设"状态卡片
   - 显示关联的人设名称和飞书配置
   - Toast提示"已关联人设xxx的飞书配置"

**T4: 测试连接**
1. 切换到"手动配置"标签页
2. 验证表单已自动填充关联的配置
3. 点击"测试连接"
4. 验证：连接成功，显示表格字段列表

**T5: 解除关联**
1. 切换回"人设关联"标签页
2. 点击"解除关联"按钮
3. 验证：
   - 关联状态清除
   - 恢复到人设选择界面
   - Toast提示"已解除人设关联"

**T6: 持久化验证**
1. 建立关联后刷新页面
2. 验证：关联配置仍然显示，无需重新选择

## 文件变更清单

### 0103XHS (小红书应用)

| 文件路径 | 变更类型 | 说明 |
|----------|----------|------|
| server/routers.ts | 修改 | 新增listByUserId和getFeishuConfig API |

### feishu-gaoding-web (稿定设计应用)

| 文件路径 | 变更类型 | 说明 |
|----------|----------|------|
| client/src/components/PersonaSelector.tsx | 新增 | 人设选择器组件 |
| client/src/pages/Settings.tsx | 修改 | 添加Tabs和人设关联功能 |
| .env.example | 修改 | 添加VITE_XHS_API_URL配置 |
| V4.2_DEVELOPMENT_GUIDE.md | 新增 | 本开发指南 |

## 部署步骤

### 1. 部署0103XHS更新

```bash
cd 0103XHS
git add .
git commit -m "feat(v4.2): 添加跨应用API支持人设数据拉取"
git push origin v4.2
```

### 2. 部署feishu-gaoding-web更新

```bash
cd feishu-gaoding-web
git add .
git commit -m "feat(v4.2): 添加人设关联功能，支持从小红书应用拉取配置"
git push origin v4.2
```

### 3. 配置Railway环境变量

在feishu-gaoding-web的Railway服务中添加：
- `VITE_XHS_API_URL`: `https://0103xhs-production.up.railway.app`

### 4. 验证部署

1. 访问feishu-gaoding-web
2. 进入Settings页面
3. 执行端到端测试用例

## 故障排除

### 问题1: 拉取人设列表失败

**可能原因**:
- VITE_XHS_API_URL配置错误
- 0103XHS服务不可用
- CORS配置问题

**解决方案**:
1. 检查环境变量配置
2. 确认0103XHS服务状态
3. 检查0103XHS的CORS配置

### 问题2: 获取完整配置失败

**可能原因**:
- 用户ID不匹配
- 人设已被删除

**解决方案**:
1. 确认登录用户与人设所有者一致
2. 在0103XHS中检查人设是否存在

### 问题3: 关联配置丢失

**可能原因**:
- localStorage被清除
- 浏览器隐私模式

**解决方案**:
1. 检查浏览器localStorage
2. 重新建立关联

## 后续优化建议

1. **服务端存储关联**: 将关联配置存储到数据库，实现跨设备同步
2. **配置同步**: 当0103XHS中的人设飞书配置更新时，自动同步到feishu-gaoding-web
3. **多人设支持**: 支持同时关联多个人设，快速切换
4. **关联历史**: 记录关联历史，支持快速恢复


## V4.2 测试结果总结

### 测试执行日期
2026-01-06

### 测试结果

| 测试ID | 测试场景 | 结果 |
|--------|----------|------|
| T1 | 拉取人设列表 | ✅ 通过 |
| T2 | 选择人设 | ✅ 通过 |
| T3 | 建立关联 | ✅ 通过 |
| T4 | 测试连接 | ⚠️ 部分通过（数据不完整） |
| T5 | 解除关联 | ✅ 通过 |
| T6 | 持久化验证 | ✅ 通过 |

### 已知问题

1. **前端输入框问题**: 0103XHS的人设编辑对话框中，飞书配置的输入框存在状态管理问题，导致只保存第一个字符
2. **数据库差异**: 两个应用使用不同的数据库类型（PostgreSQL vs MySQL）

### REST API更新

V4.2版本中，为了解决tRPC跨域调用问题，在0103XHS中添加了REST API端点：

```javascript
// server/_core/index.ts
app.get('/api/public/personas', async (req, res) => {
  // 获取用户的人设列表（带飞书配置）
});

app.get('/api/public/persona/:personaId/feishu-config', async (req, res) => {
  // 获取指定人设的完整飞书配置
});
```

---
*文档最后更新: 2026-01-06 15:47 UTC+8*
